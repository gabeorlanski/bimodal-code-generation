experiments:
  CodeParrot:
    overrides:
      objective: 'lm'
      device: 0
      +disable_cache: True
      tracking:
        log_model: false

      model: 'lvwerra/codeparrot'
    ablations:
      Exceptions:
        ++task.dump_name: exceptions
      General:
        ++task.dump_name: general
      HighQual:
        ++task.dump_name: high_qual

    steps:
      - name: PreTrain
        base: pretrain_config
        group: SO
        overrides:
          task: so
      - name: FineTune
        base: greene_config
        group: MBPP
        overrides:
          task: mbpp
          ++is_checkpoint: True
          ++model_path: best_models/${..previous_step.save_name}
    commands:
      - '{%- set pretrain_jid= "pretrain_jid"+ idx|string -%}'
      - '{{ pretrain_jid }}=$(sbatch --parsable --account=cds --job-name={{ name }}_pretrain 
      train.sbatch {{ PreTrain.path }})'
      - 'echo "Submitted PreTrain (id=${{ pretrain_jid }})"'
      - 'train_jid{{ idx}}=$(sbatch --parsable --dependency=afterok:${{pretrain_jid}}
      --account=cds --job-name={{ name }}_train train.sbatch {{ FineTune.path}})'
      - 'echo "Submitted Train (id=$train_jid{{ idx}})"'
      - 'eval_jid{{idx}}=$(sbatch --parsable --job-name={{ name }}_eval --account=cds
      --dependency=afterok:$train_jid{{ idx}} eval.sbatch best_models/{{ FineTune.save_name }} validation,test 25)'
      - 'echo "Submitted Eval $eval_jid{{idx}} to run after $1(id=$train_jid{{ idx}})"'
